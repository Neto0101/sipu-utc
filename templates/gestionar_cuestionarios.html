<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti√≥n de Cuestionarios</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
* {margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body {background:#f5f5f5;color:#333;padding-top:140px;}

header{
  position:fixed;top:0;width:100%;background:#fff;border-bottom:1px solid #ddd;
  box-shadow:0 2px 8px rgba(0,0,0,.1);z-index:1000;
}
.navbar{
  display:flex;justify-content:center;align-items:center;padding:15px 0;gap:40px;
}
.navbar a{
  color:#0d47a1;text-decoration:none;font-weight:500;font-size:16px;
  position:relative;padding:5px 0;cursor:pointer;
}
.navbar a:hover{color:#1565c0;}
.navbar a::after{
  content:"";position:absolute;width:0;height:2px;bottom:-3px;left:0;
  background:#1565c0;transition:.3s;
}
.navbar a:hover::after{width:100%;}
.logout-btn{color:#6c757d !important;}

main{text-align:center;}
h3{color:#0d47a1;margin-bottom:25px;}

form{
  background:white;margin:0 auto;padding:25px;border-radius:20px;
  box-shadow:0 6px 20px rgba(0,0,0,.1);width:80%;max-width:700px;text-align:left;
}
input,select{
  width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;margin:10px 0;
}
button{
  background:#0d47a1;color:white;border:none;padding:10px 20px;
  border-radius:25px;font-weight:600;cursor:pointer;
}
.opcion-item{display:flex;gap:10px;margin-bottom:8px;}

table{
  width:90%;margin:40px auto;border-collapse:collapse;
  box-shadow:0 6px 20px rgba(0,0,0,.1);
}
th{background:#0d47a1;color:white;padding:10px;}
td{padding:10px;border-bottom:1px solid #ddd;text-align:center;}

.editar{background:#fbc02d;color:black;}
.eliminar{background:#e53935;}

.modal-bg{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:2000;
}
.modal{
  background:white;padding:30px;border-radius:12px;width:420px;text-align:center;
}
.modal-buttons{display:flex;justify-content:space-between;margin-top:25px;}
.btn-confirm{background:#d9534f;color:white;padding:10px 25px;border:none;border-radius:5px;}
.btn-cancel{background:#6c757d;color:white;padding:10px 25px;border:none;border-radius:5px;}
</style>
</head>

<body>

<header>
  <nav class="navbar">
    <a href="#">Cuestionario Personal</a>
    <a class="logout-btn" onclick="abrirModal()">Cerrar Sesi√≥n</a>
  </nav>
</header>

<main>
<h3>Gesti√≥n del Cuestionario Personal</h3>

<form method="POST">
  <label>Pregunta:</label>
  <input type="text" name="pregunta" required>

  <!-- ‚úÖ NUEVO: ELEMENTO MANUAL -->
  <label>Elemento (factor):</label>
  <input type="text" name="elemento" placeholder="Ej. Emocional, Econ√≥mico, Social" required>

  <label>Tipo:</label>
  <select name="tipo_pregunta" id="tipo_pregunta">
    <option value="texto">Texto</option>
    <option value="opcion_multiple">Opci√≥n m√∫ltiple</option>
  </select>

  <div id="contenedor_opciones" style="display:none;">
    <h4>Opciones y pesos</h4>
    <div id="lista_opciones"></div>
    <button type="button" onclick="agregarOpcion()">‚ûï Agregar opci√≥n</button>
  </div>

  <div style="text-align:center;margin-top:20px;">
    <button type="submit">Guardar</button>
  </div>
</form>

{% if preguntas %}
<table>
<tr>
  <th>ID</th>
  <th>Pregunta</th>
  <th>Elemento</th> <!-- ‚úÖ NUEVA COLUMNA -->
  <th>Opciones</th>
  <th>Acciones</th>
</tr>

{% for p in preguntas %}
<tr>
<td>{{ p.id }}</td>
<td>{{ p.texto }}</td>

<!-- ‚úÖ MOSTRAR ELEMENTO (FACTOR) -->
<td>{{ p.elemento or '' }}</td>

<td>
{% for op in p.opciones %}
{{ op.etiqueta }} ({{ op.peso }})<br>
{% endfor %}
</td>
<td>
<button class="editar"
        onclick='editarPregunta({{ p.id }}, {{ p.texto|tojson }}, {{ (p.elemento or "")|tojson }}, {{ p.opciones | tojson | safe }})'>
  ‚úèÔ∏è
</button>

<form method="POST" style="display:inline;">
<input type="hidden" name="eliminar_id" value="{{ p.id }}">
<button class="eliminar">üóëÔ∏è</button>
</form>
</td>
</tr>
{% endfor %}
</table>
{% endif %}
</main>

<!-- MODAL EDITAR -->
<div class="modal-bg" id="modalEditar">
  <div class="modal">
    <form method="POST">
      <input type="hidden" name="editar_id" id="editar_id">
      <input type="hidden" name="editar_tipo" id="editar_tipo">

      <label>Pregunta:</label>
      <input type="text" name="editar_texto" id="editar_texto" required>

      <!-- ‚úÖ NUEVO: EDITAR ELEMENTO -->
      <label>Elemento (factor):</label>
      <input type="text" name="editar_elemento" id="editar_elemento" required>

      <div id="editar_opciones"></div>

      <div class="modal-buttons">
        <button type="submit" class="btn-confirm">Guardar cambios</button>
        <button type="button" class="btn-cancel" onclick="cerrarEditar()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL CERRAR SESI√ìN -->
<div class="modal-bg" id="modalConfirmacion">
  <div class="modal">
    <h3>¬øEst√° seguro de cerrar sesi√≥n?</h3>
    <div class="modal-buttons">
      <button class="btn-confirm" onclick="window.location.href='{{ url_for('logout') }}'">S√≠</button>
      <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
const tipo = document.getElementById("tipo_pregunta");
const opcionesBox = document.getElementById("contenedor_opciones");
const lista = document.getElementById("lista_opciones");

tipo.addEventListener("change", () => {
  opcionesBox.style.display = tipo.value == "opcion_multiple" ? "block" : "none";
});

function agregarOpcion(){
  const div = document.createElement("div");
  div.classList.add("opcion-item");

  const op = document.createElement("input");
  op.name="opciones[]"; op.placeholder="Opci√≥n"; op.required=true;

  const peso = document.createElement("input");
  peso.name="pesos[]"; peso.type="number"; peso.step="0.01"; peso.required=true;

  const btn = document.createElement("button");
  btn.type="button"; btn.textContent="‚ùå"; btn.onclick=()=>div.remove();

  div.append(op,peso,btn);
  lista.appendChild(div);
}

// ‚úÖ AHORA RECIBE ELEMENTO TAMBI√âN
function editarPregunta(id,texto,elemento,opciones){
  document.getElementById("editar_id").value=id;
  document.getElementById("editar_texto").value=texto;
  document.getElementById("editar_tipo").value="opcion_multiple";
  document.getElementById("editar_elemento").value=elemento || "";

  let cont=document.getElementById("editar_opciones");
  cont.innerHTML="";

  opciones.forEach(op=>{
    cont.innerHTML += `
      <div class="opcion-item">
        <input name="editar_opciones[]" value="${op.etiqueta}" required>
        <input name="editar_pesos[]" type="number" step="0.01" value="${op.peso}" required>
      </div>
    `;
  });

  document.getElementById("modalEditar").style.display="flex";
}

function cerrarEditar(){
  document.getElementById("modalEditar").style.display="none";
}

function abrirModal(){
  document.getElementById("modalConfirmacion").style.display="flex";
}

function cerrarModal(){
  document.getElementById("modalConfirmacion").style.display="none";
}
</script>

</body>
</html>
